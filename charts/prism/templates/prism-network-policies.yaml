# Copyright (c) Ultraviolet
# SPDX-License-Identifier: Apache-2.0
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-am-certs-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: am-certs
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
        podSelector:
          matchLabels:
            app.kubernetes.io/instance: {{ .Release.Namespace }}
            app.kubernetes.io/name: prometheus-node-exporter
            app.kubernetes.io/part-of: prometheus-node-exporter
            app.kubernetes.io/component: metrics
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
        podSelector:
          matchLabels:
            app: prometheus-prometheus
            app.kubernetes.io/instance: {{ .Release.Namespace }}
            app.kubernetes.io/part-of: prometheus

    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
        podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.amCerts.httpPort }}
        - protocol: TCP
          port: {{ .Values.amCerts.grpcPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlamcerts
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: openbao
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-backends-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: backends
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.backends.httpPort }}
        - protocol: TCP
          port: {{ .Values.backends.grpcPort }}
        - protocol: TCP
          port: {{ .Values.backends.cvmsPort }}
        - protocol: TCP
          port: {{ .Values.backends.managerGrpcPort }}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-auth-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: auth
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: am-certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: users
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
      - protocol: TCP
        port: {{ .Values.auth.httpPort }}
      - protocol: TCP
        port: {{ .Values.auth.grpcPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlauth
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}


---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-billing-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: billing
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: users
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.billing.httpPort }}
        - protocol: TCP
          port: {{ .Values.billing.grpcPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlbilling
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: redis-clients
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-cvms-billing-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: cvm-billing
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlcvmbilling
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: redis-clients
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-computations-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: computations
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.computations.httpPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlcomputations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}


---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-domains-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: domains
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: am-certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.domains.httpPort }}
        - protocol: TCP
          port: {{ .Values.domains.grpcPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqldomains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: redis-clients
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-spicedb-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: spicedb
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}

    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: ui
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: users
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresqlspicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}


---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-ui-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: ui
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.ui.httpPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: am-certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: backends
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: computations
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: certs
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: billing
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: domains
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: users
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}

    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to: [ ]
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
    - to: [ ]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-users-network-policy
spec:
  podSelector:
    matchLabels:
      app: {{ .Release.Name }}
      component: users
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/name: prometheus-node-exporter
              app.kubernetes.io/part-of: prometheus-node-exporter
              app.kubernetes.io/component: metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              app: prometheus-prometheus
              app.kubernetes.io/instance: {{ .Release.Namespace }}
              app.kubernetes.io/part-of: prometheus
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector: {}
    - from:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: traefik
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - from:
      - podSelector:
          matchLabels:
            app: {{ .Release.Name }}
            component: ui
        namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - ports:
        - protocol: TCP
          port: {{ .Values.users.httpPort }}
        - protocol: TCP
          port: {{ .Values.users.grpcPort }}
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: primary
              app.kubernetes.io/name: postgresqlusers
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: pgbouncer
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: auth
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app: {{ .Release.Name }}
              component: spicedb
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: jaeger
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/name: nats
          namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
    - to: [ ]
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
    - to: [ ]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
